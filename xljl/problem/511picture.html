<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>选择照片</title>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
        <meta content="yes" name="apple-mobile-web-app-capable">
        <meta content="black" name="apple-mobile-web-app-status-bar-style">
        <meta content="telephone=no" name="format-detection">
        <link href="../public/style/public.css" rel="stylesheet" type="text/css">
        <!--<link href="../style/index.css" rel="stylesheet" type="text/css">-->
        <link href="../style/rounds.css" rel="stylesheet" type="text/css">
        <link href="../public/style/alert/css/qikoo.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../public/style/progress/progress.css"/>
 		<link href="../public/style/slideBar.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="../cordova.js"></script>
        <script type="text/javascript" src="../js/public.js"></script>
        <script type="text/javascript" src="../public/js/jquery.js"></script>
        <script type="text/javascript" src="../public/js/jQuery.alertShow.js"></script>
        <script type="text/javascript" src="../js/public/joint.js"></script>
        <script type="text/javascript" src="../js/AJAX/prodBuild.js"></script>
	</head>
	<style>
		.photoControls .upload .checkNum {
			line-height: 2em;
		}
	</style>
	<body >
		<div class="indexPage" style="background-color: #eeeeee;">		
		<div class="photos">
			<ul>
				<li class="camera">
					<img class="cameraImg" src='../img/picList1.jpg'></img>
				</li>
				<li></li>
				<label for="doc-form-file">
					<li class="localPicture">
						<input id="doc-form-file" type="file"  onchange="onchengfun()"  accept="image/*" >
						<img class="localPictureImg" src='../img/picList3.png'></img>
					</li>
				</label>
			</ul>
		</div>
		
		<div class="photoControls">
			<div class="checkAll">
				<p class="checkAllImg"></p>
				<p>全选</p>
				<p class="border"></p>
			</div>
			<div class="edit">
				<p class="editImg"></p>
				<p>编辑</p>
				<p class="border"></p>
			</div>
			<div class="delete">
				<p class="deleteImg"></p>
				<p>删除</p>
				<p class="border"><p>
			</div>
			<div class="upload">
				<p class="uploadImg"></p>
				<p>上传</p>
				<p class="checkNum">0</p>
			</div>
		</div>
	</div>
	</body>
</html>
<script type="text/javascript">
	var probId = window.location.search.split('=')[1];
	var piclists=[];
    var filename;
    var picPath;
    var n = 0;
	$(function(){
//			$("body").append('<div class="progress-radial progress-0" id="prog"><b></b></div>');
//		    $("body").append('<div class="loadingMoveDiv" id="loadingGifDiv" style="top: 0;"></div>');
//		    $('#prog').css("height",$('#prog').css("width"))
//		    var n=0
//		    setInterval(function(){
//		    	n++
//		    	$('#prog').attr("class","progress-radial progress-"+n)
//		    	if (n>100) {
//		    		n=0
//		    	}
//		    },100)
		    
		photoList();
		
		var pictureSource;		//图片来源
        var destinationType;		//设置返回值的格式
		document.addEventListener("deviceready", onDeviceReady, false);
		
		function onDeviceReady() {
            pictureSource = mam.navigator.camera.PictureSourceType;
            destinationType = mam.navigator.camera.DestinationType;
            
        }
		
		$('.photos .camera').on('click',function(){
//			 alert("正在启动照相机设备 是否启动");
	         mam.navigator.camera.getPicture(onSuccess, onError, {quality: 100});
		})
		function onSuccess(imageData) {
			
			$("body").append('<div class="loading" id="loadingGif" style="display:block"><img src="../../img/loading.gif"></div>');
		   	$("body").append('<div class="loadingMoveDiv" id="loadingGifDiv" style="top: 0;"></div>');
			var setTime=setTimeout(function(){ 
	    		$("#loadingGif").remove();
			   	$("#loadingGifDiv").remove();
			},10000);
			
			mylocation(imageData);
			
			//需要和照片绑定的数据
//			var posx ="";
//			var posy ="";
//			var address="";
//			var time = new Date().getTime();
//			var desc = "";
//			var fileName = imageData.substring(imageData.lastIndexOf('/')+1,imageData.length);
//			var editType = "0";
//			var chuzhi = "0";
//			
//      	$('<li><img class="pict" src="'+imageData+'"/><input type="checkbox" value="'+time+'"/><img class="checkImg" src="../img/dui.png"/></li>').appendTo('.photos ul')
//      	$('.photos ul li').css('height',$('.photos ul li').width());
//			//把需要的数据放到以time为键的localstorage中
//			window.localStorage.setItem(time,posy+','+posx+','+fileName+','+address+','+imageData+','+editType+','+time+','+desc+','+chuzhi);
//			
//			
//			//把时间放到巡视记录id下的localStorage中
//			var times = window.localStorage.getItem('prob'+probId);
//			if(times){
//				times = times +','+time;
//			}else{
//				times = time;
//			}
//			window.localStorage.setItem('prob'+probId,times);
//			
//			
//			//把记录id/time 的值存到localstorage中
//			probPhotos();
	    }
	
	    function onError(cameraError) {
	        console.log("onError() cameraError:" + cameraError);
	    }
	})
	
	function mylocation(imageData){
    	
    	mam.navigator.openSwitch.lbs(successCallback,errorCallBack);
		function successCallback(v){
			var posx = v.longitude;
		   	var posy = v.latitude;
	       	var address =v.address;
	       	chuanZhi(posy,posx,address,imageData)
	       	
	       	$("#loadingGif").remove();
			$("#loadingGifDiv").remove();
			clearTimeout(setTime);
		}
		function errorCallBack(){
			qikoo.dialog.alert('没有获取到位置');
         	
         	$("#loadingGif").remove();
			$("#loadingGifDiv").remove();
			clearTimeout(setTime);
		}
	}
	
	function chuanZhi(posy,posx,address,imageData){
		if(address){
			var time = new Date().getTime();
			var desc = "";
			var fileName = imageData.substring(imageData.lastIndexOf('/')+1,imageData.length);
			var editType = "0";
			var chuzhi = "1";
			
        	$('<li><img class="pict" src="'+imageData+'"/><input type="checkbox" value="'+time+'"/><img class="checkImg" src="../img/dui.png"/></li>').appendTo('.photos ul')
        	$('.photos ul li').css('height',$('.photos ul li').width());
			//把需要的数据放到以time为键的localstorage中
			window.localStorage.setItem(time,posy+','+posx+','+fileName+','+address+','+imageData+','+editType+','+time+','+desc+','+chuzhi);
			
			//把时间放到巡视记录id下的localStorage中
			var times = window.localStorage.getItem('prob'+probId);
			if(times){
				times = times +','+time;
			}else{
				times = time;
			}
			window.localStorage.setItem('prob'+probId,times);
			
			//把记录id/time 的值存到localstorage中
			probPhotos();
		}else{
			qikoo.dialog.alert("拍摄失败")
		}
	}
	
	//查看本地是否有未提交照片
	function photoList(){
		$("body").append('<div class="loading" id="loadingGif" style="display:block"><img src="../img/loading.gif"></div>');
	    $("body").append('<div class="loadingMoveDiv" id="loadingGifDiv" style="top: 0;"></div>');
	    var setTime=setTimeout(function(){ 
			$("#loadingGif").remove();
			$("#loadingGifDiv").remove();
		},30000);
		
		var times = window.localStorage.getItem('prob'+probId);
		if(times){
			var time = times.split(",");
			var len = time.length;
			for(var i = 0;i < len;i++){
				
				var temp = window.localStorage.getItem(time[i]);
				if(temp){
					var url = temp.split(",")[4];
					var editType = temp.split(",")[5];
					$('<li><img class="pict" src="'+url+'"/><input type="checkbox" value="'+time[i]+'"/><img class="checkImg" src="../img/dui.png"/><img class="editType" style="display: '+ifEdit(editType)+';" src="../img/redactBtn.png"></li>').appendTo('.photos ul')
					
				}
			}
		}
		//设置li的高度
		$('.photos ul li').css('height',$('.photos ul li').width());
		
		$("#loadingGif").remove();
		$("#loadingGifDiv").remove();
		clearTimeout(setTime);
	}
	function ifEdit(str){
		if(str=="0"){
			return "none";
		}else{
			return "block";
		}
		
	}
	//点击图片提示勾选标记、上传按钮右上角的数量变化
	$('.photos ul').delegate('li .pict', 'click', function(){
		var input = $(this).next();
		if(input.prop('checked')){
			input.prop('checked',false);
		}else{	
			input.prop('checked',true);
		}	
		input.next().toggle();
		$('.photoControls .upload .checkNum').text($('.photos ul li input:checked').length);
	})
	//全选功能
	$('.photoControls .checkAll').on('click',function(){
		$('.photos ul li input').prop('checked',true);
		$('.photos ul li .checkImg').show();
		$('.photoControls .upload .checkNum').text($('.photos ul li input:checked').length);
	})
	//编辑功能
	$('.photoControls .edit').on('click',function(){
		var len = $('.photos ul li input:checked').length;
		if(len > 1){
			qikoo.dialog.alert('请只选一张图片进行编辑');
		}else if(len == 0){
			qikoo.dialog.alert('未选择图片');
		}else{
			
			var time = $('.photos ul li input:checked').val();
			window.location.href = '512picRedact.html?time='+time;
		}
	})
	
	//删除功能
	$('.photoControls .delete').on('click',function(){
		var inputs = $('.photos ul li input:checked');
		if(!inputs[0]){
			qikoo.dialog.alert('未选择图片');
		}else{
			var len = inputs.length;
			var times = window.localStorage.getItem('prob'+probId);
			for(var i = 0;i<len ;i++){
				var time = inputs[i].value;
				
				if(times.indexOf(time+",")!=-1){
					times=times.replace(time+",","");
				}else if(times.indexOf(","+time)!=-1){
					times=times.replace(","+time,"");
				}else{
					times=times.replace(time,"");
				}
				window.localStorage.removeItem(time);
			}
			$('.photos ul li input:checked').parent().remove();
			$('.photoControls .upload .checkNum').text($('.photos ul li input:checked').length);
			var probId_editTime = probId +"/"+ new Date().getTime();
			var probPhotos = window.localStorage.getItem('probPhotos');
			if(times!=""){
				probPhotos = probPhotos +","+probId_editTime;
				window.localStorage.setItem('prob'+probId,times);
			}else{
				window.localStorage.removeItem('prob'+probId);
			}
			
			var temp = probPhotos.split(",");
			var len = temp.length;
			for(var i=0;i<len;i++){
				if(temp[i].indexOf(probId)!=-1){
					temp.splice(i,1);
					break;
				}
			}
			for(var i = 0;i<len-1;i++){
				if(i==0){
					probPhotos = temp[i]
				}else{
					probPhotos = probPhotos +","+temp[i]
				}
			}
			window.localStorage.setItem('probPhotos',probPhotos);
		}
	})
	//上传功能
	$('.photoControls .upload').on('click',function(){
		var inputs = $('.photos ul li input:checked');
		if(!inputs[0]){
			qikoo.dialog.alert('未选择图片');
		}else{
			var len = inputs.length;
			var times = window.localStorage.getItem('prob'+probId);
			$("body").append('<div class="loading" id="loadingGif" style="display:block"><img src="../img/loading.gif"></div>');
//			$("body").append('<div class="progress-radial progress-0" id="prog" data-max="'+len+'"><b></b></div>');
//			$('#prog').css("height",$('#prog').css("width"))
		    $("body").append('<div class="loadingMoveDiv" id="loadingGifDiv" style="top: 0;"></div>');
		    var setTime=setTimeout(function(){ 
//				$("#prog").remove();
				$("#loadingGif").remove();
				$("#loadingGifDiv").remove();
			},60000*len);	
			for(var i = 0;i<len ;i++){
				
				var time = inputs[i].value;
				var temp = window.localStorage.getItem(time);
				
				if(temp.split(",")[5]=="1"){
					
					var url = temp.split(",")[4];
					
					if(url.indexOf("file:///storage/emulated/0")==-1){
		                url = url.replace("file:///storage/sdcard0", "/storage/sdcard0");
		            }else{
		                url = url.replace("file:///storage/emulated/0", "/storage/emulated/0");
		            }
					var jsonObj = eval('('+data.data012.request+')');
				    jsonObj.data.probId = probId;
				    jsonObj.data.time = temp.split(",")[6];
				    jsonObj.data.address = temp.split(",")[3];
				    jsonObj.data.posy = temp.split(",")[0];
				    jsonObj.data.posx = temp.split(",")[1];
				    jsonObj.data.fileName = temp.split(",")[2];
				    jsonObj.data.desc = temp.split(",")[7];
				    jsonObj.data.is_edit = temp.split(",")[8];
				    var jsonStr = JSON.stringify(jsonObj);
				    data.data012.request = jsonStr;
					var data1={"method":"entry","request":encodeURIComponent(data.data012.request)};
		//			var data={"method":"entry","request":""};
		           	upload(url,data1,times,time,inputs[i]);
				}else{
					qikoo.dialog.alert("不能上传未编辑图片")
//					$("#prog").remove();
					$("#loadingGif").remove();
					$("#loadingGifDiv").remove();
					clearTimeout(setTime);
					
					return
				}
			}
		}
	})
	function upload(url,data1,times,time,input){
		mam.navigator.appupload.appServerUpload(successUploadPICCallback, errCallback, "GCGKJL", "JL", url, data1);
		function successUploadPICCallback(obj){
//			qikoo.dialog.alert("上传成功")
			input.parentNode.remove();
			$('.photoControls .upload .checkNum').text($('.photos ul li input:checked').length);
			if(times.indexOf(time+",")!=-1){
//				alert("1")
				times=times.replace(time+",","");
			}else if(times.indexOf(","+time)!=-1){
//				alert("2")
				times=times.replace(","+time,"");
			}else{
//				alert("3")
				times=times.replace(time,"");
			}
			window.localStorage.removeItem(time);
			var probId_editTime = probId +"/"+ new Date().getTime();
			var probPhotos = window.localStorage.getItem('probPhotos');
			if(times!=""){
				probPhotos = probPhotos +","+probId_editTime;
				window.localStorage.setItem('prob'+probId,times);
//				alert("4")
			}else{
				window.localStorage.removeItem('prob'+probId);
//				alert("5")
			}
			var temp = probPhotos.split(",");
			var len = temp.length;
			for(var i=0;i<len;i++){
				if(temp[i].indexOf(probId)!=-1){
					temp.splice(i,1);
					break;
				}
			}
			for(var i = 0;i<len-1;i++){
				if(i==0){
					probPhotos = temp[i]
				}else{
					probPhotos = probPhotos +","+temp[i]
				}
			}
			window.localStorage.setItem('probPhotos',probPhotos);		
//			$("#loadingGif").remove();
//			$("#loadingGifDiv").remove();
//			clearTimeout(setTime);

//			var max = $('#prog').attr("data-max");
//			n = n + 1;
//			var m = Math.round((n/max)*100)
////			$('#prog').attr("class","progress-radial progress-"+m)
//			if (n==$('#prog').attr("data-max")) {
//				n=0;
				qikoo.dialog.alert("上传成功")
//				$("#prog").remove();
				$("#loadingGif").remove();
				$("#loadingGifDiv").remove();
				clearTimeout(setTime);
//			}
		}
		function errCallback(obj){
		    alert(obj);
			qikoo.dialog.alert("上传失败")
//			$("#prog").remove();
			$("#loadingGif").remove();
			$("#loadingGifDiv").remove();
			clearTimeout(setTime);
			
			return
		}
	}
	
	function onchengfun(){
		if($('#doc-form-file').val()){
			
			$("body").append('<div class="loading" id="loadingGif" style="display:block"><img src="../img/loading.gif"></div>');
		    $("body").append('<div class="loadingMoveDiv" id="loadingGifDiv" style="top: 0;"></div>');
		    var setTime=setTimeout(function(){ 
				$("#loadingGif").remove();
				$("#loadingGifDiv").remove();
			},30000);
			
			var file = document.getElementById('doc-form-file').files[0];
			var reader = new FileReader();
			reader.onload = function (e) {
				var dataURL = e.target.result;
			  	navigator.ContentCompression.getPicturePath(pathsuccessCallback,patherrorCallback,dataURL.split('base64,')[1]);
			  	function pathsuccessCallback(v){
					//需要和照片绑定的数据
					var imageData =v.result;
					var posy = "";
					var posx = "";
					var address = "";
					var time = new Date().getTime();
					var desc = "";
					var fileName = imageData.substring(imageData.lastIndexOf('/')+1,imageData.length);
					var editType = "0";
					var chuzhi ="1";
		        	$('<li><img class="pict" src="'+imageData+'"/><input type="checkbox" value="'+time+'"/><img class="checkImg" src="../img/dui.png"/></li>').appendTo('.photos ul')
		        	$('.photos ul li').css('height',$('.photos ul li').width());
					//把需要的数据放到以time为键的localstorage中
					window.localStorage.setItem(time,posy+','+posx+','+fileName+','+address+','+imageData+','+editType+','+time+','+desc+','+chuzhi);
					
					
					//把时间放到巡视记录id下的localStorage中
					var times = window.localStorage.getItem('prob'+probId);
					if(times){
						times = times +','+time;
					}else{
						times = time;
					}
					window.localStorage.setItem('prob'+probId,times);
					//把记录id/time 的值存到localstorage中
					probPhotos();
					$('#doc-form-file').val('');
					
					$("#loadingGif").remove();
					$("#loadingGifDiv").remove();
					clearTimeout(setTime);
				}	
			    function patherrorCallback(){
	                qikoo.dialog.alert("图片处理失败，请重试");
	                $('#doc-form-file').val('');
	                
	                $("#loadingGif").remove();
					$("#loadingGifDiv").remove();
					clearTimeout(setTime);
		        }
			}
			     reader.readAsDataURL(file);
		}
	}
	
	
	
	
	
	
	
	
	
	
	//把记录probId/time 的值存到localstorage中,新增图片用
	function probPhotos(){
		var probPhotos = window.localStorage.getItem('probPhotos');
		var probId_editTime = probId +"/"+ new Date().getTime();
		if(probPhotos){
			if(probPhotos.indexOf(probId)!=-1){
				var temp = probPhotos.split(",");
				var len = temp.length;
				for(var i=0;i<len;i++){
					if(temp[i].indexOf(probId)!=-1){
						temp.splice(i,1);
						break;
					}
				}
				for(var i = 0;i<len-1;i++){
					if(i==0){
						probPhotos = temp[i]
					}else{
						probPhotos = probPhotos +","+temp[i]
					}
				}
						
			}
			probPhotos = probPhotos +","+probId_editTime;
			
		}else{
			probPhotos = probId_editTime;
		}
		window.localStorage.setItem('probPhotos',probPhotos);
	}
</script>