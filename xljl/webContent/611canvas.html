<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>图片绘制</title>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <link href="../public/style/public.css" rel="stylesheet" type="text/css">
    <link href="../style/photo.css" rel="stylesheet" type="text/css">
    <link type="text/css" rel="stylesheet" href="../style/canvas.css">
    <link href="../public/style/alert/css/qikoo.css" rel="stylesheet">
    <link href="../public/style/slideBar.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="../public/js/jquery.js"></script>
    <script type="text/javascript" src="../public/js/canvas/hammer.min.js"/></script>
    <script type="text/javascript" src="../public/js/canvas/js.js"></script>
    <script type="text/javascript" src="../cordova.js"></script>
    <script type="text/javascript" src="../js/public.js"></script>
   	<script type="text/javascript" src="../public/js/jQuery.alertShow.js"></script>
   	<script type="text/javascript" src="../js/joint.js"></script>
</head>
<body >
<div class="indexPage" style="background: #eee">				
<section class="cell-9 canvas compile">
    <canvas class="cvs" id="canvas"></canvas>
</section>
<div class="colorList compileCanvas" style="display: none;">
    <span class="green">green</span>
    <span class="red">red</span>
    <span class="blue">blue</span>
    <span class="black">black</span>
    <span class="grey">grey</span>
    <span class="yellow">yellow</span>
    <span class="purple">purple</span>
    <span class="Gold">Gold</span>
</div>
<section class="cell-2 picCanvas">
    <div class="cancel"><i><img src="../img/cvs1.png"></i><span>取消</span></div>
    <div class="color"><i><img src="../img/cvs2.png"></i><span>绘图</span></div>
    <div class="clear"><i><img src="../img/cvs3.png"></i><span>清空</span></div>
    <div class="save"><i><img src="../img/cvs4.png"></i><span>保存</span></div>
</section>
<div>
</body>
</html>
<script>
	var time = window.location.search.split('=')[1];
	var temp = window.localStorage.getItem(time);
	var compile=$('.compile')
    var canvas = document.getElementById('canvas');
    var cxt = canvas.getContext("2d");
    var beauty = new Image();
	$(function(){
        beauty.src = temp.split(",")[4];
//		beauty.src = "../images/picList2.jpg"
        canvas.width = compile.width();
        canvas.height = compile.height();
        if(beauty.complete){
	        cxt.drawImage(beauty, 0, 0, compile.width(), compile.height());
        	
        }else{
        	beauty.onload = function(){
        		cxt.drawImage(beauty, 0, 0, compile.width(), compile.height());
        	}
        }
        var t = false;
        var num=1;
        var color=null;

        $('.compileCanvas span').each(function (index) {
            $(this).click(function () {
                color=$(this).text();
            })
        });
        canvas.addEventListener('touchstart',function(e){
            var e = window.event || e;
            var X = e.touches[0].pageX - this.offsetLeft;
            var Y = e.touches[0].pageY - this.offsetTop;
            cxt.beginPath();
            cxt.strokeStyle = color;
            cxt.lineWidth=num;
            cxt.moveTo(X, Y);
            t = true;
        })
        
		canvas.addEventListener('touchmove',function(e){
			
			var e = window.event || e;
			e.preventDefault();
            var X = e.touches[0].pageX - this.offsetLeft;
            var Y = e.touches[0].pageY - this.offsetTop;
            if (t) {
                cxt.lineTo(X, Y);
                cxt.stroke();
            }
		})
		canvas.addEventListener('touchend',function(e){
			t = false;
		})
		canvas.addEventListener('touchcancel',function(e){
			t = false;
		})
	})



	$('.cancel').on('click',function(){
		history.back();
	})
	$('.color').on('click',function(){
		$('.colorList').toggle();
	})
	$('.clear').on('click',function(){
		cxt.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
        var beauty = new Image();
        beauty.src = temp.split(",")[4];
//		beauty.src = "../images/picList2.jpg"
        canvas.width = compile.width();
        canvas.height = compile.height();
        cxt.drawImage(beauty, 0, 0, compile.width(), compile.height());
	})
	$('.save').on('click',function(){
		var url = canvas.toDataURL()
		navigator.ContentCompression.getPicturePath(pathsuccessCallback,patherrorCallback,url.split('base64,')[1]);
		function pathsuccessCallback(v){
			var t = temp.split(",");
			var len = t.length;
			t[4] = v.result;
			for(var i=0;i<len;i++){
    			if(i==0){
    				temp=t[i];
    			}else{
    				temp=temp+","+t[i];
    			}
    		}
			window.localStorage.setItem(time,temp);
    		history.back();
		}
		function patherrorCallback(v){
			 qikoo.dialog.alert("图片处理失败，请重试");
		}
	})
</script>