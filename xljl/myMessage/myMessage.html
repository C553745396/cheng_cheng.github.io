<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>我的消息</title>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <link href="../public/style/public.css" rel="stylesheet" type="text/css">
    <link href="../style/index.css" rel="stylesheet" type="text/css">
    <link href="../public/style/alert/css/qikoo.css" rel="stylesheet">
	 <link href="../public/style/slideBar.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="../cordova.js"></script>
	<script type="text/javascript" src="../public/js/public.js"></script>
	<script type="text/javascript" src="../public/js/jquery.js"></script>
	<script type="text/javascript" src="../js/public/joint.js"></script>
	<script type="text/javascript" src="../public/js/jQuery.alertShow.js"></script>
    <script type="text/javascript" src="../js/AJAX/coreBuild.js"></script>
<style>
    	.mymessageSection {
    width: 100%;
    height: 72%;
    overflow: hidden;
    overflow-y: auto;
}

.mymessageSection ul {
    width: 100%;
    height: auto;
    overflow: hidden;
}

.mymessageSection ul li {
    width: 100%;
    height: 2.8rem;
    overflow: hidden;
    padding: .4rem 0;
    line-height: 2.8rem;
    border-bottom: 1px dashed #a09f9f;
}


.mymessageSection ul li input{
	float: left;
	display: none;
	margin-top: 1.1rem;
	margin-left: 5%;
}

.mymessageSection ul li p {
    height: 2.8rem;
    float: left;
    font-size: 1em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 3rem;
}
.mymessageSection_left {
    width: 40%;
    margin-left: 5%;
}

.mymessageSection_right {
    width: 38%;
    color: #7c7c7c;
    margin-left: 2%;
}

.mymessageSection ul li i {
    /*width: 2%;
    height: 2.8rem;
    line-height: 2.8rem;*/
    /*float: right;*/
}

.mymessageSection ul li i img {
    /*height: 1.2rem;
    width: 1.8rem;*/
   width: 6%;
   height: auto;
    /*vertical-align: middle;*/
   margin-top: 0.15rem;
   margin-left: 2%;
}
.noticeNum p {
    width: 50%;
    float: left;
    background: #85ccd1;
    line-height: 3rem;
    text-align: center;
    font-size: 1.2rem;
    color: #fff;
}

.noticeNum p:last-child {
    background: #92ddf1;
}
.noticeNum p:first-child i {
    position: relative;
    top: 0.2rem;
    right: 1.5rem;
    font-size: .7em;
}
.messControll{
	width: 100%;
	height: 50px;
	position: fixed;
	bottom: 0;
	/*background-color: #FFF;*/
}
.messControll div{
	width: 33%;
	height: 100%;
	float: left;
	text-align: center;
}
.messControll span{
	width: 50%;
	height: 50%;
	display: inline-block;
	float: left;
	position: relative;
	top: 25%;
	left: 25%;
	border-radius: 5px;
	color: #fff;
	line-height: 2em;
}
.messControll .edit{
	background-color: #C0C0C0;
}
.messControll .checkAll{
	background-color: #C0C0C0;
}
.messControll .delete{
	background-color: #C0C0C0;
}
.num {
    float: right;
    width: 1.4rem;
    height: 1.4rem;
    line-height: 1.4rem;
    border-radius: .7rem;
    text-align: center;
    color: #fff;
    box-shadow: 0 2px 2px 1px #69a1af;
    font-style: normal;
    background: #ff4200;
}
    </style>
</head>
<body >
	<div class="indexPage replyMessage"
<div class="cell-1 noticeNum">
    <p id="noticeLen">未读</p>
    <p>已读</p>
</div>
	<section class="cell-8  mymessageSection">
		<ul>

		</ul>
	</section>
</div>
<div class="messControll">
	<div><span class="edit">编辑</span></div>
	<div><span class="checkAll" style="display: none;">全选</span></div>
	<div><span class="delete" style="display: none;">删除</span></div>
</div>
</div>
</body>
<script type="text/javascript">
	var uId = localStorage.getItem("userId");
    $(function () {
//  	window.localStorage.removeItem(uId+"messArr")
//  	window.localStorage.removeItem(uId+"messId")
        document.addEventListener("deviceready", onDeviceReady, false);
        function onDeviceReady () {
        	//获取消息列表信息
			var messId = null;//localStorage.getItem(uId+"messId");
	    	if(messId!=null){
	    		var jsonObj = eval('('+coreData.data013.request+')');
				jsonObj.data.retIds = messId;
				var jsonStr = JSON.stringify(jsonObj);
				coreData.data013.request = jsonStr;
				getJSON(url, coreData.data013, data013)
	    	}else{
	    		getJSON(url, coreData.data013, data013)
	    	}
	    }
        function data013(v2){
        	if(v2.data.cont){
	    		var dataObj = eval(v2.data.cont)
	    		var localarr = localStorage.getItem(uId+"messArr")
	        	if(localarr==null){
					for (var a in dataObj){
	        			dataObj[a].lookType='0'
	        		}	
					    
					localStorage.setItem(uId+"messArr",JSON.stringify(dataObj))
	        	}else{
					for (var a in dataObj){
	        			dataObj[a].lookType='0'
	        		}	
					localarr = JSON.stringify(dataObj) + "&" + localarr 
					localStorage.setItem(uId+"messArr",localarr)
	        	}
	        	var notiIdStr = "";
	        	for (var i in dataObj){
	        		var notiId = dataObj[i].ID
	        		if(notiIdStr==""){
	        			notiIdStr = notiId
	        		}else{
	        			notiIdStr = notiIdStr+","+notiId
	        		}
	    		}
	        	localStorage.setItem(uId+"messId",notiIdStr)
	    	}
        	
        	
            var localarr = localStorage.getItem(uId+"messArr")
			if(localarr!=null){
	        	var arr = new Array();
	        	arr = localarr.split("&")
	        	var a=0;
		    	for(var i in arr){
		    		var jobj = JSON.parse(arr[i])
		    		for(var j in jobj){
		    			if(jobj[j].lookType=='0'){
		    				a++
		    			}
		    		}
		    	}
		    	if(a!=0){
		    		document.getElementById("noticeLen").innerHTML='未读<i class="num">'+a+'</i>'
		    	}
	        	
	        	$('.mymessageSection ul').find('li').remove();
	        	for(var i in arr){
	        		var jobj = JSON.parse(arr[i])
	        		for(var j in jobj){
	        			var notty = jobj[j].TYPE
	        			if(jobj[j].lookType=='0'){
	        				if(notty=='1'){
		        				$('<li class="cell-1"><input type="checkbox"  value="' + jobj[j].ID + '" /><p class="mymessageSection_left" id="' + jobj[j].ID + '">' + jobj[j].CONTENT + '</p><p class="mymessageSection_right" id="' + jobj[j].ID + '">' + jobj[j].SEND_TIME + '</p><i><img src="../img/replyunread.png"></i></li>').appendTo('.mymessageSection ul')	
		        			}else{
		        				$('<li class="cell-1"><input type="checkbox"  value="' + jobj[j].ID + '" /><p class="mymessageSection_left" id="' + jobj[j].ID + '">' + jobj[j].CONTENT + '</p><p class="mymessageSection_right" id="' + jobj[j].ID + '">' + jobj[j].SEND_TIME + '</p><i><img src="../img/noticeunread.png"></i></li>').appendTo('.mymessageSection ul')	
		        			}
	        			}
	        		}
	        	}
        	}
   		}
        
        $('.mymessageSection ul').delegate('p','click', function (e) {
        	var tID = e.target.id
        	var localarr = localStorage.getItem(uId+"messArr")
        	if(localarr!=null){
	        	var lookarr = "";
	        	var arr = new Array();
	        	arr = localarr.split("&")
	        	for(var i in arr){
	        		var jobj = JSON.parse(arr[i])
	        		for(var j in jobj){
	        			if(tID==jobj[j].ID){
	        				jobj[j].lookType='1'
	        				//jobj[j].lookType='1'
	        				window.location.href = 'checkMessage.html?tID='+tID+'&type='+jobj[j].TYPE
	        			}
	        		}
	        		if(lookarr==""){
	        			lookarr = JSON.stringify(jobj)
	        		}else{
	        			lookarr = lookarr + "&" + JSON.stringify(jobj)
	        		}
	        		
	        	}
	        	localStorage.setItem(uId+"messArr",lookarr)
        	}
        	
        })
        $('.noticeNum').delegate('p:eq(0)','click', function (e) {
        	$('.noticeNum p').eq(0).css('background','#85ccd1');
    		$('.noticeNum p').eq(1).css('background','#92ddf1');
        	var localarr = localStorage.getItem(uId+"messArr")
        	if(localarr!=null){
	        	var arr = new Array();
	        	arr = localarr.split("&")
	        	$('.mymessageSection ul').find('li').remove();
	        	for(var i in arr){
	        		var jobj = JSON.parse(arr[i])
	        		for(var j in jobj){
	        			var notty = jobj[j].TYPE
	        			if(jobj[j].lookType=='0'){
	        				if(notty=='1'){
		        				$('<li class="cell-1"><input type="checkbox"  value="' + jobj[j].ID + '" /><p class="mymessageSection_left" id="' + jobj[j].ID + '">' + jobj[j].CONTENT + '</p><p class="mymessageSection_right" id="' + jobj[j].ID + '">' + jobj[j].SEND_TIME + '</p><i><img src="../img/replyunread.png"></i></li>').appendTo('.mymessageSection ul')	
		        			}else{
		        				$('<li class="cell-1"><input type="checkbox"  value="' + jobj[j].ID + '" /><p class="mymessageSection_left" id="' + jobj[j].ID + '">' + jobj[j].CONTENT + '</p><p class="mymessageSection_right" id="' + jobj[j].ID + '">' + jobj[j].SEND_TIME + '</p><i><img src="../img/noticeunread.png"></i></li>').appendTo('.mymessageSection ul')	
		        			}
	        			}
	        		}
	        	}
        	}
        })
        $('.noticeNum').delegate('p:eq(1)','click', function (e) {
        	$('.noticeNum p').eq(0).css('background','#92ddf1');
    		$('.noticeNum p').eq(1).css('background','#85ccd1');
        	var localarr = localStorage.getItem(uId+"messArr")
        	if(localarr!=null){
	        	var arr = new Array();
	        	arr = localarr.split("&")
	        	$('.mymessageSection ul').find('li').remove();
	        	for(var i in arr){
	        		var jobj = JSON.parse(arr[i])
	        		for(var j in jobj){
	        			var notty = jobj[j].TYPE
	        			if(jobj[j].lookType=='1'){
	        				if(notty=='1'){
		        				$('<li class="cell-1"><input type="checkbox"  value="' + jobj[j].ID + '" /><p class="mymessageSection_left" id="' + jobj[j].ID + '">' + jobj[j].CONTENT + '</p><p class="mymessageSection_right" id="' + jobj[j].ID + '">' + jobj[j].SEND_TIME + '</p><i><img src="../img/replyread.png"></i></li>').appendTo('.mymessageSection ul')	
		        			}else{
		        				$('<li class="cell-1"><input type="checkbox"  value="' + jobj[j].ID + '" /><p class="mymessageSection_left" id="' + jobj[j].ID + '">' + jobj[j].CONTENT + '</p><p class="mymessageSection_right" id="' + jobj[j].ID + '">' + jobj[j].SEND_TIME + '</p><i><img src="../img/noticeread.png"></i></li>').appendTo('.mymessageSection ul')	
		        			}
	        			}
	        		}
	        	}
        	}
        })
        
        $('.edit').on('click',function(){
        	$('.checkAll').toggle();
        	$('.delete').toggle();
        	var t = $(this).text();
        	if(t=="编辑"){
	        	$(this).text("取消")
        	}else{
        		$(this).text("编辑")
        	}
        	$('.mymessageSection input').toggle();
        })
        $('.checkAll').on('click',function(){
        	if($('.mymessageSection input:checked').length<$('.mymessageSection input').length){
	        	$('.mymessageSection input').prop('checked',true)
	        	$(this).text("反选")
        	}else{
        		$('.mymessageSection input').prop('checked',false)
        		$(this).text("全选")
        	}
        })
        $('.mymessageSection input').on('click',function(){
        	if($('.mymessageSection input:checked').length<$('.mymessageSection input').length){
	        	$('.checkAll').text("全选")
        	}else{
        		$('.checkAll').text("反选")
        	}
        })
        
        $('.delete').on('click',function(){
        	var inputs = $('.mymessageSection input:checked');
        	var len = inputs.length;
        	if(len==0){
        		qikoo.dialog.alert("请选择需要删除的消息")
        	}else{
        		
    			var localarr = localStorage.getItem(uId+"messArr")
    			var delarr = ""
				if(localarr!=null){
					var arr = new Array();
					arr = localarr.split("&")
					for(var i in arr){
						var jobj = JSON.parse(arr[i])
						for(var j in jobj){
							for(var k = 0;k<len;k++){
		        				var id = inputs[k].value;
		        				if(jobj[j]){
			        				if(jobj[j].ID==id){
										delete jobj[j]
									}
		        				}
		        			}
						}
						
						var bakarr = ""
						for(var b=0; b<jobj.length;b++){
							if(jobj[b]){
								if(bakarr==""){
									bakarr = JSON.stringify(jobj[b])
								}else{
									bakarr = bakarr +","+ JSON.stringify(jobj[b])
								}
							}
						}
						if(delarr==""){
							if(bakarr)
								delarr = "["+bakarr+"]"
						}else{
							if(bakarr)
								delarr = delarr + "&" + "["+bakarr+"]"
						}
					}
					if(delarr!=""){
						localarr = delarr
						localStorage.setItem(uId+"messArr",localarr)
					}else{
						localStorage.removeItem(uId+"messArr")
					}
					
					var localarr = localStorage.getItem(uId+"messArr")
		        	if(localarr!=null){
			        	var arr = new Array();
			        	arr = localarr.split("&")
			        	var a=0;
				    	for(var i in arr){
				    		var jobj = JSON.parse(arr[i])
				    		for(var j in jobj){
				    			if(jobj[j].lookType=='0'){
				    				a++
				    			}
				    		}
				    	}
				    	if(a!=0){
				    		document.getElementById("noticeLen").innerHTML='未读<i class="num">'+a+'</i>'
				    	}
		        	}else{
		        		document.getElementById("noticeLen").innerHTML='未读'
		        	}
				}
    			inputs.parent().remove()
    			$('.checkAll').toggle();
    			$('.delete').toggle();
    			$('.edit').text("编辑");
    			$('.mymessageSection input').toggle();
    		
    		}
        	
        })
        
    })
</script>    
</html>