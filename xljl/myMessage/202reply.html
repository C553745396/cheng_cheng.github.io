<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>消息详情</title>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta content="telephone=no" name="format-detection">
		<link href="../public/style/public.css" rel="stylesheet">
		<link href="../style/index.css" rel="stylesheet">
		<link href="../public/style/alert/css/qikoo.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="../public/style/touchzoom/scale.css" />
		 <link href="../public/style/slideBar.css" rel="stylesheet" type="text/css">
		<script type="text/javascript" src="../cordova.js"></script>
		<script type="text/javascript" src="../public/js/public.js"></script>
		<script type="text/javascript" src="../public/js/jquery.js"></script>
		<script type="text/javascript" src="../public/js/jQuery.alertShow.js"></script>
		<script type="text/javascript" src="../js/public/joint.js"></script>
		<script type="text/javascript" src="../js/AJAX/coreBuild.js"></script>
		<script src="../public/js/touchzoom/scale.js" type="text/javascript"></script>
		<style>
			.messTable{
				width: 100%;
				height: 85%;
				overflow-x: hidden;
				overflow-y: auto;
			}
			.messTable .mess{
				width: 100%;
				height: auto;
			}
			/*收到的消息*/
			.messageCome{
				width: 100%;
				height: auto;
				margin-top: 10px;
				margin-bottom: 20px;
			}
			.messageCome .touxiangCome{
				width: 13%;
				height: 80px;
				display: inline-block;
				margin-left: 2%;
				float: left;
				background: url(../img/touxiang.png)no-repeat center;
				background-size: 80% auto;
			}
			.messageCome>div{
				width: 80%;
				height: auto;
				display: inline-block;
				float: left;
			}
			.messageCome>div .nameCome{
				width: 100%;
				height: 30px;
				display: inline-block;
				float: left;
				font-size: 14px;
				line-height: 200%;
			}
			.messageCome>div .messageboxCome{
				width: 95%;
				height: auto;
				display: inline-block;
				float: left;
				margin-left: 5%;
				position: relative;
			}
			.messageCome>div .messageboxCome .sanjiaoCome{
				width: 0;
				height:0;
				display: block;
				border-top: 8px solid #fff;
				border-right: 8px solid #fff;
				border-bottom: 8px solid #f2f2f2;
				border-left: 8px solid #f2f2f2;
				position: absolute;
				left: -16px;
				top: 10px;
			}
			.messageCome>div .messageboxCome .messageContentCome{
				width: auto;
				height: auto;
				display: inline-block;
				padding-left: 5%;
				padding-right: 5%;
				padding-top: 10px;
				padding-bottom: 10px;
				background-color: #fff;
				font-size: 14px;
				line-height: 120%;
				border-radius: 5px;
			}
			/*.messageCome>div .timeCome{
				width: 100%;
				height: 20px;
				display: inline-block;
				font-size: 12px;				
				line-height: 200%;
				text-align: center;
			}*/
			.messageCome .timeCome{
				width: 100%;
				height: 20px;
				display: inline-block;
				font-size: 12px;
				/*text-indent: 10%;*/
				line-height: 200%;
				/*text-indent: 38%;*/
				text-align: center;
			}
			/*发送的消息*/
			.messageSend{
				width: 100%;
				height: auto;
				margin-top: 10px;
				margin-bottom: 20px;
			}
			.messageSend .touxiangSend{
				width: 13%;
				height: 80px;
				display: inline-block;
				margin-right: 2%;
				float: right;
				background: url(../img/touxiang.png)no-repeat center;
				background-size: 80% auto;
			}
			.messageSend>div{
				width: 80%;
				height: auto;
				display: inline-block;
				float: right;
			}
			.messageSend>div .nameSend{
				width: 100%;
				height: 30px;
				display: inline-block;
				float: right;
				font-size: 14px;
				line-height: 200%;
				text-align: right;
			}
			.messageSend>div .messageboxSend{
				width: 95%;
				height: auto;
				display: inline-block;
				float: right;
				margin-right: 5%;
				position: relative;
			}
			.messageSend>div .messageboxSend .sanjiaoSend{
				width: 0;
				height:0;
				display: block;
				border-top: 8px solid #32b16c;
				border-right: 8px solid #f2f2f2;
				border-bottom: 8px solid #f2f2f2;
				border-left: 8px solid #32b16c;
				position: absolute;
				right: -16px;
				top: 10px;
			}
			.messageSend>div .messageboxSend .messageContentSend{
				width: auto;
				height: auto;
				display: inline-block;
				padding-left: 5%;
				padding-right: 5%;
				padding-top: 10px;
				padding-bottom: 10px;
				background-color: #32b16c;
				font-size: 14px;
				line-height: 120%;
				float: right;
				color: #fff;
				border-radius: 5px;
			}
			/*.messageSend>div .timeSend{
				width: 100%;
				height: 20px;
				display: inline-block;
				font-size: 12px;
				line-height: 200%;
				text-align: center;
			}*/
			.messageSend .timeSend{
				width: 100%;
				height: 20px;
				display: inline-block;
				font-size: 12px;
				/*text-indent: 10%;*/
				line-height: 200%;
				/*text-indent: 38%;*/
				text-align: center;
			}
			/*.messageSend .timeSend{
				width: 100%;
				height: 20px;
				display: inline-block;
				font-size: 12px;
				line-height: 200%;
				text-align: center;
			}*/
			.sendMessage {
			    width: 100%;
			    height: 50px;
			    position: absolute;
			    bottom: 0;
			    background: #e5e5e5;
			}
			.sendMessage input{
				width: 62%;
				height: 68%;
				display: inline-block;
				float: left;
				position: relative;
				top: 16%;
				margin-left: 2%;
				border: none;
				border-radius: 3px;
				outline: none;
			}
			.sendMessage>span{
				width: 15%;
				height: 68%;
				display: inline-block;
				float: left;
				font-size: 14px;
				text-align: center;
				line-height: 260%;
				color: #fff;
				border-radius: 2px;
				margin-left: 2%;
				position: relative;
				top: 16%;
				
			}
			.sendMessage>span.messageIcon{
				background-color: #32b16c;	
			}
			.sendMessage>span.sendBtn{
				background-color: #ff6f00;	
			}
			.reply {
			    float: right;
			    background-color: #ffb83d;
			    border-radius: .3em;
			    padding: .3em .4em;
			    margin-right: 4em;
			}

		</style>
	</head>
	<body>
		<div class="indexPage replyMessage">		
		<section class="messTable">
			<div class="mess">
				
				<div class="messageCome">
					<span class="touxiangCome"></span>
					<div>
						<span class="nameCome"></span>
						<div class="messageboxCome">
							<span class="sanjiaoCome"></span>
							<span class="messageContentCome">
								暂无消息
							<!--	新的电力项目进度表已发送到你的邮箱，请注意查收，还有图片也发你了，看看有什么没有需要更改的。-->
							</span>
						</div>
						
					</div>
					<span class="timeCome"><!--14:14:05--></span>
				</div>
				<div id="sendShowDiv">
				<div class="messageSend" style="display: none;">
					<span class="touxiangSend"></span>
					<div>
						<span class="nameSend"><!--我--></span>
						<div class="messageboxSend">
							<span class="messageContentSend">
								<!--收到，一会发给你-->
							</span>
							<span class="sanjiaoSend"></span>
						</div>
						
					</div>
					<span class="timeSend"><!--14:14:05--></span>
				</div>
				
				</div>
				
			</div>
		</section>
		<section id="sendSec" class="sendMessage">
			<input type="text" id="textNotice">
			<span id="messageBrowse" class="messageIcon">浏览</span>
			<span id="messageSend" class="sendBtn">发送</span>
		</section>
		<section class="imgzoom_pack">
			<div class="imgzoom_img"><img src="" /></div>
		</section>
			</div>
	</body>

</html>
<script type="text/javascript">
	var uId = localStorage.getItem("userId")
	var tID = window.location.search.substring(window.location.search.indexOf('=')+1,window.location.search.indexOf('&'));
	var noticeType = window.location.search.split('=')[2].substr(0,1);
	$(function(){
		messageComeHeight()
		messageSendHeight()
		
	    document.addEventListener("deviceready", onDeviceReady, false);
	    function onDeviceReady () {
	    	var jsonObj = eval('('+coreData.data014.request+')');
			jsonObj.data.id = tID;
			var jsonStr = JSON.stringify(jsonObj);
			coreData.data014.request = jsonStr;
			getJSON(url, coreData.data014, data014)
	    }
	    function data014(v){
	    	var dataObj = eval(v.data.cont)
	    	if(dataObj){
	    		$(".nameCome").text(dataObj[0].SENDER)
		    	$(".timeCome").text(dataObj[0].SEND_TIME)
				$(".messageContentCome").text(dataObj[0].CONTENT)
	    	}
	    	var jsonObj = eval('('+coreData.data021.request+')');
			jsonObj.data.id = tID;
			var jsonStr = JSON.stringify(jsonObj);
			coreData.data021.request = jsonStr;
			getJSON(url, coreData.data021, data021)
	    }
	    function data021(v){
	   		var datas = v.data.cont
	   		var sendHtml = ""
	   		for(var i=0;i<datas.length;i++){
	   			var urls = datas[i].URL;
	   			var html = ""
	   			if(urls!=""){
	   				var tupians = urls.split(",")
	   				for(var j=0;j<tupians.length;j++){
	   					var bandx = tupians[j].split(";")
			   			html = html+'<span id="'+bandx[0]+'"> <img style="width:30px;height:15px" src="'+bandx[1]+'">&nbsp;  </span>'
	   				}
	   			}
	   			sendHtml = sendHtml + '<div class="messageSend"><span class="touxiangSend"></span><div><span class="nameSend">'+datas[i].RESPONSER+'</span><div class="messageboxSend towerImgs"><span class="messageContentSend">'+datas[i].RESPONSE_MSG + html+'</span><span class="sanjiaoSend"></span></div></div><span class="timeSend">'+datas[i].RESPONSE_TIME+'</span></div>'
	   		}
	   		document.getElementById("sendShowDiv").innerHTML=sendHtml
	   		$('.towerImgs img').attr('draggable',false);
	   		ImagesZoom.init({
					"elem": ".towerImgs"
			});
	   		
	    }
	  var succId = "0"
	  var urlstr = ""
	  var setTime
		$('#messageSend').on('click',function(){
			var cont = document.getElementById("textNotice").value
			var nowTime = getNowTime()
			var sendHtml = '<div class="messageSend"><span class="touxiangSend"></span><div><span class="nameSend">'+localStorage.getItem("userName")+'</span><div class="messageboxSend"><span class="messageContentSend">'+cont+'</span><span class="sanjiaoSend"></span></div></div><span class="timeSend">'+nowTime+'</span></div>'
	   		$(".sendShowDiv").append(sendHtml)
			var choose = window.sessionStorage.getItem('choose'+tID);
			var jsonObj = eval('('+coreData.data020.request+')');
			jsonObj.data.MESSAGE_ID = tID;
			jsonObj.data.RESPONSE_MSG = cont;
			if(choose==null||choose==""){
				jsonObj.data.picture = '0'
				var jsonStr = JSON.stringify(jsonObj);
				coreData.data020.request = jsonStr;
				getJSON(url, coreData.data020, function(e){
					document.getElementById("textNotice").value="";
					var jsonObj = eval('('+coreData.data021.request+')');
					jsonObj.data.id = tID;
					var jsonStr = JSON.stringify(jsonObj);
					coreData.data021.request = jsonStr;
					getJSON(url, coreData.data021, data021)
					var localarr = localStorage.getItem(uId+"messArr")
		        	if(localarr!=null){
			        	var lookarr = "";
			        	var arr = new Array();
			        	arr = localarr.split("&")
			        	for(var i in arr){
			        		var jobj = JSON.parse(arr[i])
			        		for(var j in jobj){
			        			if(tID==jobj[j].ID){
			        				jobj[j].sendType='1'
			        			}
			        		}
			        		if(lookarr==""){
			        			lookarr = JSON.stringify(jobj)
			        		}else{
			        			lookarr = lookarr + "&" + JSON.stringify(jobj)
			        		}
			        		
			        	}
			        	localStorage.setItem(uId+"messArr",lookarr)
		        	}
				})
			}else{
				var chooseArr = choose.split(",")
				var len = chooseArr.length
				$("body").append('<div class="loading" id="loadingGif" style="display:block"><img src="../img/loading.gif"></div>');
			    $("body").append('<div class="loadingMoveDiv" id="loadingGifDiv" style="top: 0;"></div>');
			    setTime=setTimeout(function(){ 
					$("#loadingGif").remove();
					$("#loadingGifDiv").remove();
				},60000*len);
				var temp = window.sessionStorage.getItem(chooseArr[0])
				var posy = temp.split(",")[0];
				var posx = temp.split(",")[1];
				var url = temp.split(",")[2];
				jsonObj.data.posy = posy;
				jsonObj.data.posx = posx;
				jsonObj.data.id = "0"
				
				var jsonStr = JSON.stringify(jsonObj);
				coreData.data020.request = jsonStr;
				var data1={"method":"entry","request":encodeURIComponent(coreData.data020.request)};
				upload(url,data1);
			}
	
		})
		function upload(url,data1){
			mam.navigator.appupload.appServerUpload(successUploadPICCallback, errCallback, "XLJL_CORE", "CORE_SERVER", url, data1);
			function successUploadPICCallback(obj){
				var jsonObja = eval('(' + obj + ')');
	        	var choose = window.sessionStorage.getItem('choose'+tID);
	        	var chooseArr = choose.split(",")
				var len = chooseArr.length
				if(len>1){
					var cont = document.getElementById("textNotice").value
					var jsonObj = eval('('+coreData.data020.request+')');
					jsonObj.data.MESSAGE_ID = tID;
					jsonObj.data.RESPONSE_MSG = cont;
					for(var i =1;i<len;i++){
						var temp = window.sessionStorage.getItem(chooseArr[i])
						var posy = temp.split(",")[0];
						var posx = temp.split(",")[1];
						var url = temp.split(",")[2];
						jsonObj.data.posy = posy;
						jsonObj.data.posx = posx;
						jsonObj.data.id = jsonObja.data.id;
						var jsonStr = JSON.stringify(jsonObj);
						coreData.data020.request = jsonStr;
						var data1={"method":"entry","request":encodeURIComponent(coreData.data020.request)};
						upload1(url,data1);
					}
				}else{
					document.getElementById("textNotice").value=""
					qikoo.dialog.alert("发送成功")
					
					var jsonObj = eval('('+coreData.data021.request+')');
					jsonObj.data.id = tID;
					var jsonStr = JSON.stringify(jsonObj);
					coreData.data021.request = jsonStr;
					getJSON(url, coreData.data021, data021)
				
					$("#loadingGif").remove();
					$("#loadingGifDiv").remove();
					clearTimeout(setTime);
					
					var localarr = localStorage.getItem(uId+"messArr")
		        	if(localarr!=null){
			        	var lookarr = "";
			        	var arr = new Array();
			        	arr = localarr.split("&")
			        	for(var i in arr){
			        		var jobj = JSON.parse(arr[i])
			        		for(var j in jobj){
			        			if(tID==jobj[j].ID){
			        				jobj[j].sendType='1'
			        			}
			        		}
			        		if(lookarr==""){
			        			lookarr = JSON.stringify(jobj)
			        		}else{
			        			lookarr = lookarr + "&" + JSON.stringify(jobj)
			        		}
			        		
			        	}
			        	localStorage.setItem(uId+"messArr",lookarr)
		        	}
				}
//                window.sessionStorage.setItem('choose'+tID,'');
			}
			function errCallback(obj){
				qikoo.dialog.alert("发送失败")
				$("#loadingGif").remove();
				$("#loadingGifDiv").remove();
				clearTimeout(setTime);
			}
		}
		function upload1(url,data1){
			mam.navigator.appupload.appServerUpload(successUploadPICCallback, errCallback, "XLJL_CORE", "CORE_SERVER", url, data1);
			function successUploadPICCallback(obj){
				document.getElementById("textNotice").value=""
				qikoo.dialog.alert("发送成功")
				var jsonObj = eval('('+coreData.data021.request+')');
				jsonObj.data.id = tID;
				var jsonStr = JSON.stringify(jsonObj);
				coreData.data021.request = jsonStr;
				getJSON(url, coreData.data021, data021)
			
				$("#loadingGif").remove();
				$("#loadingGifDiv").remove();
				clearTimeout(setTime);
				
				var localarr = localStorage.getItem(uId+"messArr")
	        	if(localarr!=null){
		        	var lookarr = "";
		        	var arr = new Array();
		        	arr = localarr.split("&")
		        	for(var i in arr){
		        		var jobj = JSON.parse(arr[i])
		        		for(var j in jobj){
		        			if(tID==jobj[j].ID){
		        				jobj[j].sendType='1'
		        			}
		        		}
		        		if(lookarr==""){
		        			lookarr = JSON.stringify(jobj)
		        		}else{
		        			lookarr = lookarr + "&" + JSON.stringify(jobj)
		        		}
		        		
		        	}
		        	localStorage.setItem(uId+"messArr",lookarr)
	        	}

			}
			function errCallback(obj){
				qikoo.dialog.alert("发送失败")
				$("#loadingGif").remove();
				$("#loadingGifDiv").remove();
				clearTimeout(setTime);
			}
		}
		
	})
	
	$('#messageBrowse').on('click',function(){
		var messId = window.location.search.substring(window.location.search.indexOf('=')+1,window.location.search.indexOf('&'));
		window.location.href = '204picture.html?messId='+messId;
	})
	
	//设置messageCome的高度
	function messageComeHeight(){
		var h1 = $('.nameCome')[0].offsetHeight;
		var h2 = $('.messageboxCome')[0].offsetHeight;
		var h3 = $('.timeCome')[0].offsetHeight;
		var h = h1+h2+h3;
		$('.messageCome').css('height',h+'px')
	}
	//设置messageSend的高度
	function messageSendHeight(){
		var h1 = $('.nameSend')[0].offsetHeight;
		var h2 = $('.messageboxSend')[0].offsetHeight;
		var h3 = $('.timeSend')[0].offsetHeight;
		var h = h1+h2+h3;
		$('.messageSend').css('height',h+'px')
	}	
	
</script>