<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title></title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="format-detection" content="telephone=no">

        <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
       <!-- <link rel="stylesheet" type="text/css" href="http://www.jq22.com/jquery/font-awesome.4.6.0.css">-->
    </head>
    <body>
        <div class="m">
            <div class="top">
                <span>$t('機頭紙列表清單')</span>
            </div>
            <div style='margin:10px 0;'>
                <button class="layui-btn layui-btn-small" id="close">$t('關閉')</button>
                <!-- <button class="layui-btn layui-btn-small" id="close">關閉/開啟</button> -->
                <button class="layui-btn layui-btn-small" id="maintenance">$t('維護用紗')</button>
                <button class="layui-btn layui-btn-small" id="produce">$t('產生布票')</button>
                <button class="layui-btn layui-btn-small" id="preview">$t('預覽機頭紙')</button>
                <button class="layui-btn layui-btn-small" id="stamp">$t('打印機頭紙')</button>
            </div>
            <div style='margin-bottom:20px;overflow: hidden;'>
                <span class='f'>
                    <label class="layui-form-label">$t('工單號碼')<span style='color:red;'>*</span></label>
                    <div class="layui-inline">
                        <!-- <input type="text" id="txtOrderNo"> -->
                        <input type="text" value="800000027" id="txtOrderNo">
                    </div>
                </span>
                <span class='f'>
                    <label class="layui-form-label"><span class='v_d'>布號</span>$t('布號')</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled id="fabricCode">
                    </div>
                </span>
                <span class='f'>
                    <label class="layui-form-label"><span class='v_d'>布號共</span>$t('花樣')</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled id="patternNo">
                    </div>
                </span>
                <span class='f'>
                    <label class="layui-form-label"><span class='v_d'>&nbsp;</span>$t('尺寸(扁機)')</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled id="size">
                    </div>
                </span>
            </div>
            <div style='margin-bottom:20px;overflow: hidden;'>
                <span class='f' style="visibility:hidden">
                    <label class="layui-form-label">工單數量&nbsp;</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled>
                    </div>
                </span>
                <span class='f'>
                    <label class="layui-form-label">$t('工單數量')</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled id="reqQnty">
                    </div>
                </span>
                <span class='f'>
                    <label class="layui-form-label">&nbsp;&nbsp;&nbsp;&nbsp;$t('完成數量')</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled id="completedQnty">
                    </div>
                </span>
                <span class='f'>
                    <label class="layui-form-label">$t('待生產數量')</label>
                    <div class="layui-inline">
                        <input type="text" value="" disabled id="remainingQnty">
                    </div>
                </span>
            </div>

            <table id="wbrL" lay-filter="test"></table>

           
            <span id="icon">
                <i class="layui-icon shou" id='add'>&#xe654;</i>&nbsp;&nbsp;<i class="layui-icon shou" id='editor'>&#xe642;</i>&nbsp;&nbsp;<i class="layui-icon shou" id='search'>&#xe615;</i>&nbsp;&nbsp;<i class="layui-icon shou" id='renovate'>&#x1002;</i>
            </span>
        </div>

        <!-- 新增 -->
        <div id="adds" class="pad dis">
            <label for="">生產機號<span class="v_d">量</span>&nbsp;&nbsp;</label><input type="text" id="A_MACHINE_NO"><br><br>
            <label for="">分配數量<span class="v_d">量</span>&nbsp;&nbsp;</label><input type="text" id="A_QUANTITY_ALLOTTED"><br><br>
            <label for="">轉數/kg<span class="v_d">gg量</span>&nbsp;</label><input type="text" id="A_ROTATION_FREQ_PER_POUND"><br><br>
            <label for="">機頭紙備註</label>&nbsp;&nbsp;<input type="text" id="A_MCHN_JOB_SHEET_NOTE"><br><br>
            <label for="">布票備註<span class="v_d">量</span>&nbsp;&nbsp;</label><input type="text" id="A_GREIGE_BARCODE_LABEL_NOTE">
        </div>
        <!-- 编辑 -->
        <div id="editors" class="pad dis">
            <label for="">生產機號<span class="v_d">量</span>&nbsp;&nbsp;</label><input type="text" id="E_MACHINE_NO"><br><br>
            <label for="">分配數量<span class="v_d">量</span>&nbsp;&nbsp;</label><input type="text" id="E_QUANTITY_ALLOTTED"><br><br>
            <label for="">轉數/kg<span class="v_d">gg量</span>&nbsp;</label><input type="text" id="E_ROTATION_FREQ_PER_POUND"><br><br>
            <label for="">機頭紙備註</label>&nbsp;&nbsp;<input type="text" id="E_MCHN_JOB_SHEET_NOTE"><br><br>
            <label for="">布票備註<span class="v_d">量</span>&nbsp;&nbsp;</label><input type="text" id="E_GREIGE_BARCODE_LABEL_NOTE">
        </div>
        <!-- 搜索 -->
        <div id="searchs" class="pad dis">
            <div>
                <div style="margin-bottom:10px;">
                    <select name="interest" lay-filter="aihao" class="bl" id='k31'>
                        <option value="0">所有</option>
                        <option value="1">任一</option>
                    </select>
                    <button id="addSearch">+</button>
                </div>
            </div>
            <div class="searchList">
                <select name="" class="sk">
                    <option value="JOB_SHEET_NO">機頭紙號</option>
                    <option value="PRODUCTION_ORDER_NO">工單號碼</option>
                    <option value="MACHINE_NO">生產機號</option>
                    <option value="QUANTITY_ALLOTTED">分配數量</option>
                    <option value="QUANTITY_COMPLETED">完成數量</option>
                    <option value="CREATED_BY">創建者</option>
                    <option value="CREATED_DATE">創建日期</option>
                    <option value="MODIFIED_BY">修改者</option>
                    <option value="MODIFIED_DATE">修改日期</option>
                    <option value="ROTATION_FREQ_PER_POUND">轉數/kg</option>
                    <option value="MCHN_JOB_SHEET_NOTE">機頭紙備註</option>
                    <option value="GREIGE_BARCODE_LABEL_NOTE">布票備註</option>
                    <option value="CLOSE_FLAG">關閉</option>
                </select>
                <select name="" class="sc">
                    <option value="cn">等於</option>
                    <option value="eq">不等於</option>
                    <option value="bw">開始於</option>
                    <option value="bn">不開始於</option>
                    <option value="ew">結束於</option>
                    <option value="en">不結束於</option>
                    <option value="cn">包含</option>
                    <option value="nc">不包含</option>
                    <option value="">is null</option>
                    <option value="">is not null</option>
                    <option value="">在其中</option>
                    <option value="">不在其中</option>
                </select>
                <input type="text" class="sv">
                <button class="reduceSearch">-</button>
            </div>
        </div>
    </body>

    <script src="plugins/servies.js"></script>
    <script type="text/javascript" src="plugins/layui/layui.all.js"></script>
    <script type="text/javascript" src="plugins/layui/lay/modules/tables.js" ></script>
    <script src="build/js/jquery.js"></script>
    <script src="build/js/di18n.js"></script>
    <script src="build/js/lang.js"></script>
    <script type="text/html" id="switchTpl1">
      <input type="checkbox" name="sex" disabled lay-skin="primary" {{ d.CLOSE_FLAG == '0' ? 'checked' : '' }}>
      <!-- <input type="text" name="sex" lay-verify="required|phone|number"> -->
    </script>
    <script>
        $(document).ready(function(){
            layui.use(['table','laytpl'], function(){
                var table = layui.table;
                var checkedData = '';

                var hasTable = false;
                var orderNo;

                var colArr1 = [ //表头
                    {radio: true, LAY_RadioCHECKED: false,width:20},
                    {field: 'JOB_SHEET_NO', title: '機頭紙號',unresize: true,width:100}
                    ,{field: 'PRODUCTION_ORDER_NO', title: '工單號碼',unresize: true,width:110}
                    ,{field: 'MACHINE_NO', title: '生產機號',unresize: true,width:100} 
                    ,{field: 'QUANTITY_ALLOTTED', title: '分配數量',unresize: true,width:100}
                    ,{field: 'QUANTITY_COMPLETED', title: '完成數量',unresize: true,width:100}
                    ,{field: 'CREATED_BY', title: '創建者',unresize: true,width:100}
                    ,{field: 'CREATED_DATE', title: '創建日期',unresize: true,width:100}
                    // ,{field: 'CREATED_DATE', title: '創建日期',unresize: true,width:160,templet: '<div>{{ timestampToTime(d.modifyDate) }}</div>'}
                    ,{field: 'MODIFIED_BY', title: '修改者',unresize: true,width:100}
                    ,{field: 'MODIFIED_DATE', title: '修改日期',unresize: true,width:100}
                    ,{field: 'ROTATION_FREQ_PER_POUND', title: '轉數/kg',unresize: true,width:100}
                    ,{field: 'MCHN_JOB_SHEET_NOTE', title: '機頭紙備註',unresize: true,width:100}
                    ,{field: 'GREIGE_BARCODE_LABEL_NOTE', title: '布票備註',unresize: true,width:100}
                    // ,{field: 'CLOSE_FLAG', title: '關閉',unresize: true,width:69,templet: '<div><input type="checkbox" disabled {{closeit(d)}}></div>'}
                    ,{field: 'CLOSE_FLAG', title: '關閉',unresize: true,width:69,templet: '#switchTpl1'}
                ];
                arrchangeL(colArr1);
                
                //获取主列表数据
                function setTable(){
                    table.render({
                        elem: '#wbrL'
                        ,height: 315
                        ,response: {
                            statusName: 'status' //数据状态的字段名称，默认：code
                            ,statusCode: 200 //成功的状态码，默认：0
                            ,msgName: 'message' //状态信息的字段名称，默认：msg
                            // ,countName: 'totals' //数据总数的字段名称，默认：count
                            ,dataName: 'data' //数据列表的字段名称，默认：data
                        }
                        // ,request: {
                        //     pageName: 'page' //页码的参数名称，默认：page
                        //     ,limitName: 'rows' //每页数据量的参数名，默认：limit
                        // }
                        ,method: 'POST' 
                        ,where: {
                            OrderNo:$('#txtOrderNo').val()
                        } 
                        ,url: getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetGridData') //数据接口
                        ,cols: [colArr1]
                        ,id:'aaa' 
                        ,done: function (res,curr,count) {
                            layer.close(loading1);
                            $('.layui-table-cell')[0].style.zIndex = '-2';
                            layer.close(loading1);
                            $("#icon").css("display","block");   //表格下方的增、编、搜隐藏
                            hasTable = true;
                            checkedData = '';
                        }
                    });

                    //radio
                    table.on('radio(test)', function(obj){
                        // ta = obj.checked;
                        //如果触发的是全选，则为：all，如果触发的是单选，则为：one
                        checkedData = JSON.parse(JSON.stringify(obj.data));
                        // console.log(checkedData);
                        // console.log(obj.checked); //当前是否选中状态
                        // console.log(obj.data); //选中行的相关数据
                        // name = obj.data.beamNo;
                        // console.log(name)                  
                    }); 
                }

                //获取工单的其他基本数据
                function getad(){
                    $.ajax({
                        type:'POST',                                 
                        url:getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetData'),
                        data:{
                            OrderNo:$('#txtOrderNo').val()
                        },
                        success:function(data){
                            if (data.status == 200) {
                                //成功
                                //尺寸
                                $('#size').val(data.data.SIZE);
                                //布号
                                $('#fabricCode').val(data.data.FABRIC_CODE);
                                //花样
                                $('#patternNo').val(data.data.PATTERN_NO);
                                //待完成数量
                                $('#remainingQnty').val(data.data.REMAINING_QNTY);
                                //已完成数量
                                $('#completedQnty').val(data.data.COMPLETED_QNTY);
                                //工单数量
                                $('#reqQnty').val(data.data.REQ_QNTY);
                            } else {
                                layer.close(loading1);
                                layer.alert(data.message,{title:'提示'});
                            }
                        }
                    })
                }

                // setTable();
                // getad();

                var loading1 = null;
                // $("#txtOrderNo").blur(function(event){
                $("#txtOrderNo").keydown(function(event){
                    var e = window.event || event;
                    if(e.keyCode == 13){
                        loading1 = layer.load();   //正在加载中
                        orderNo = $(this).val();

                        //检查工单号是否存在
                        $.ajax({
                            type:'POST',                                 
                            url:getAjaxURL('/weftMachineJobSheet/ChkOrderNo'),
                            data:{
                                OrderNo:orderNo
                            },
                            success:function(data){
                                if (data.status == 200 && data.data == 1) {
                                    //成功
                                    getad();
                                    if (hasTable) {
                                        // console.log('reload');

                                        table.reload('aaa', {
                                            url:getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetGridData'),
                                            where:{
                                                OrderNo:orderNo
                                            }
                                        });
                                        checkedData = '';
                                    } else {
                                        setTable();
                                    }

                                } else if (data.data == 0){
                                    layer.close(loading1);
                                    layer.alert('查不到该工单号',{title:'提示'});
                                } else {
                                    layer.close(loading1);
                                    layer.alert(data.message,{title:'提示'});
                                }
                            }
                        })

                    }
                });

                // 新增
                $("#add").click(function(){
                    checkInMachineNo = false;
                    $('#A_MACHINE_NO').val('');
                    $('#A_QUANTITY_ALLOTTED').val('');
                    $('#A_ROTATION_FREQ_PER_POUND').val('');
                    $('#A_MCHN_JOB_SHEET_NOTE').val('');
                    $('#A_GREIGE_BARCODE_LABEL_NOTE').val('');

                    layer.open({
                        area: ['400px', '280px']
                        ,title:'新增記錄'
                        ,type:1
                        ,content: $('#adds')
                        ,btn: ['提交', '取消']
                        ,cancel: function(){ 
                            $('#adds').css('display','none')
                        }
                        ,yes: function(index, layero){
                            
                            // //生產機號
                            // console.log($('#A_MACHINE_NO').val());
                            // //分配數量
                            // console.log($('#A_QUANTITY_ALLOTTED').val());
                            // //轉數/kg
                            // console.log($('#A_ROTATION_FREQ_PER_POUND').val());
                            // //機頭紙備註
                            // console.log($('#A_MCHN_JOB_SHEET_NOTE').val());
                            // //布票備註
                            // console.log($('#A_GREIGE_BARCODE_LABEL_NOTE').val());

                            if ($('#A_MACHINE_NO').val() == '') {
                                layer.alert('生產機號不能为空',{title:'提示'});
                                return
                            }

                            if ($('#A_QUANTITY_ALLOTTED').val() == '') {
                                layer.alert('分配數量不能为空',{title:'提示'});
                                return
                            }

                            if (!Number($('#A_QUANTITY_ALLOTTED').val()) && $('#A_QUANTITY_ALLOTTED').val() != 0) {
                                layer.alert('分配數量:请填写有效数字',{title:'提示'});
                                return
                            }

                            // if (Number($('#A_QUANTITY_ALLOTTED').val()) > Number($('#reqQnty').val()) ) {
                            //     layer.alert('分配數量:不能大於工單數量',{title:'提示'});
                            //     return
                            // }

                            if ($('#A_ROTATION_FREQ_PER_POUND').val() == '') {
                                layer.alert('轉數不能为空',{title:'提示'});
                                return
                            }

                            if (!Number($('#A_ROTATION_FREQ_PER_POUND').val()) && $('#A_ROTATION_FREQ_PER_POUND').val() != 0) {
                                layer.alert('轉數:请填写有效数字',{title:'提示'});
                            }

                            //检查生产机号是否存在
                            $.ajax({
                                type:'POST',                                 
                                url:getAjaxURL('/weftMachineJobSheet/CheckMachineNo'),
                                data:{
                                    MachineNo:$('#A_MACHINE_NO').val()
                                },
                                success:function(data){
                                    if (data.status == 200) {
                                        //不存在
                                        if (data.data == 0) {
                                            layer.alert('不存在的生产机号',{title:'提示'});
                                        } else {
                                            getJobSheetNo();
                                        }

                                    } else {
                                        // layer.closeAll();
                                        layer.alert(data.message,{title:'提示'});
                                    }
                                }
                            })

                            //获取新的机头纸
                            function getJobSheetNo(){
                                var params = {
                                    OrderNo:$('#txtOrderNo').val(),
                                    MachineNo:$('#A_MACHINE_NO').val(),
                                    QuantityAllotted:$('#A_QUANTITY_ALLOTTED').val(),
                                    RotationFreqPerPound:$('#A_ROTATION_FREQ_PER_POUND').val(),
                                    MachineJobSheetNote:$('#A_MCHN_JOB_SHEET_NOTE').val(),
                                    GreigeBarcodeLabelNote:$('#A_GREIGE_BARCODE_LABEL_NOTE').val()
                                }
                                
                                $.ajax({
                                    type:'POST',                                 
                                    url:getAjaxURL('/weftMachineJobSheet/creatWeftJobSheetNo'),
                                    data:{},
                                    success:function(data){
                                        if (data.status == 200) {
                                            params.MachineJobSheetNo = data.data;
                                            add(params);
                                        } else {
                                            layer.alert(data.message,{title:'提示'});
                                        }
                                    }
                                })
                            }

                            //add
                            function add(p){
                                $.ajax({
                                    type:'POST',                                 
                                    url:getAjaxURL('/weftMachineJobSheet/insertWarpMachineJobSheet'),
                                    data:p,
                                    success:function(data){
                                        if (data.status == 200) {
                                            table.reload('aaa', {
                                                url:getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetGridData'),
                                            });
                                            checkedData = '';
                                            layer.closeAll();
                                            $('#adds').css('display','none');
                                            layer.alert('新增成功',{title:'提示'});
                                        } else {
                                            // layer.closeAll();
                                            layer.alert(data.message,{title:'提示'});
                                        }
                                    }
                                })    
                            }
                            

                        }
                        ,btn2: function(index, layero){
                            layer.closeAll();
                            $('#adds').css('display','none')
                        }
                    });
                });
                // 编辑
                $("#editor").click(function(){
                    //判断是否有选中
                    if (!checkedData) {
                        layer.alert('请选择编辑项',{title:'提示'});
                        return 
                    }

                    //将记录数据写入编辑栏
                    //生產機號
                    $('#E_MACHINE_NO').val(checkedData.MACHINE_NO);
                    //分配數量
                    $('#E_QUANTITY_ALLOTTED').val(checkedData.QUANTITY_ALLOTTED);
                    //轉數/kg
                    $('#E_ROTATION_FREQ_PER_POUND').val(checkedData.ROTATION_FREQ_PER_POUND);
                    //機頭紙備註
                    $('#E_MCHN_JOB_SHEET_NOTE').val(checkedData.MCHN_JOB_SHEET_NOTE);
                    //布票備註
                    $('#E_GREIGE_BARCODE_LABEL_NOTE').val(checkedData.GREIGE_BARCODE_LABEL_NOTE);

                    layer.open({
                        area: ['400px', '280px']
                        ,title:'編輯記錄'
                        ,type:1
                        ,content: $('#editors')
                        ,btn: ['提交', '取消']
                        ,cancel: function(){ 
                            $('#editors').css('display','none')
                        }
                        ,yes: function(index, layero){
                            // //生產機號
                            // console.log($('#E_MACHINE_NO').val());
                            // //分配數量
                            // console.log($('#E_QUANTITY_ALLOTTED').val());
                            // //轉數/kg
                            // console.log($('#E_ROTATION_FREQ_PER_POUND').val());
                            // //機頭紙備註
                            // console.log($('#E_MCHN_JOB_SHEET_NOTE').val());
                            // //布票備註
                            // console.log($('#E_GREIGE_BARCODE_LABEL_NOTE').val());

                            if ($('#E_MACHINE_NO').val() == '') {
                                layer.alert('生產機號不能为空',{title:'提示'});
                                return
                            }

                            if ($('#E_QUANTITY_ALLOTTED').val() == '') {
                                layer.alert('分配數量不能为空',{title:'提示'});
                                return
                            }

                            if (!Number($('#E_QUANTITY_ALLOTTED').val()) && $('#E_QUANTITY_ALLOTTED').val() != 0) {
                                layer.alert('分配數量:请填写有效数字',{title:'提示'});
                                return
                            }

                            if ($('#E_ROTATION_FREQ_PER_POUND').val() == '') {
                                layer.alert('轉數不能为空',{title:'提示'});
                                return
                            }

                            if (!Number($('#E_ROTATION_FREQ_PER_POUND').val()) && $('#E_ROTATION_FREQ_PER_POUND').val() != 0) {
                                layer.alert('轉數:请填写有效数字',{title:'提示'});
                            }

                            if ($('#E_MACHINE_NO').val() == checkedData.MACHINE_NO) {
                                edit();
                            } else {
                                //检查生产机号是否存在
                                $.ajax({
                                    type:'POST',                                 
                                    url:getAjaxURL('/weftMachineJobSheet/CheckMachineNo'),
                                    data:{
                                        MachineNo:$('#E_MACHINE_NO').val()
                                    },
                                    success:function(data){
                                        if (data.status == 200) {
                                            //不存在
                                            if (data.data == 0) {
                                                layer.alert('不存在的生产机号',{title:'提示'});
                                            } else {
                                                edit();
                                            }

                                        } else {
                                            // layer.closeAll();
                                            layer.alert(data.message,{title:'提示'});
                                        }
                                    }
                                })
                            }

                            function edit(){
                                $.ajax({
                                    type:'POST',                                 
                                    url:getAjaxURL('/weftMachineJobSheet/updateWarpMachineJobSheet'),
                                    data:{
                                        MachineJobSheetNo:checkedData.JOB_SHEET_NO,
                                        MachineNo:$('#E_MACHINE_NO').val(),
                                        QuantityAllotted:$('#E_QUANTITY_ALLOTTED').val(),
                                        RotationFreqPerPound:$('#E_ROTATION_FREQ_PER_POUND').val(),
                                        MachineJobSheetNote:$('#E_MCHN_JOB_SHEET_NOTE').val(),
                                        GreigeBarcodeLabelNote:$('#E_GREIGE_BARCODE_LABEL_NOTE').val(),
                                    },
                                    success:function(data){
                                        if (data.status == 200) {
                                            table.reload('aaa', {
                                                url:getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetGridData'),
                                            });

                                            layer.closeAll();
                                            $('#editors').css('display','none');
                                            layer.alert(data.message,{title:'提示'});
                                        } else {
                                            // layer.closeAll();
                                            layer.alert(data.message,{title:'提示'});
                                        }
                                    }
                                })
                            }
                        
                        }
                        ,btn2: function(index, layero){
                            layer.closeAll();
                            $('#editors').css('display','none');
                        }
                    });
                });
                
                // console.log($('.searchList')[0].outerHTML);
                var aList = $('.searchList')[0].outerHTML;

                //增加搜索条件
                $('#addSearch').click(function(){
                    
                    $('#searchs').append(aList)
                })

                //事件委託減少搜索條件
                $('#searchs').delegate(".reduceSearch","click",function(){
                    console.log($(this));
                    $(this).parents('.searchList').remove();

                })


                // 搜索 
                $("#search").click(function(){
                    // console.log(123)
                    layer.open({
                        area: ['450px', '280px']
                        ,title:'搜索'
                        ,type:1
                        ,content: $('#searchs')
                        ,btn: ['搜尋', '重設']
                        ,cancel: function(){ 
                            $('#searchs').css('display','none')
                        }
                        ,yes: function(index, layero){
                            
                            // console.log($('.sk').val());
                            // console.log($('.sc').val());
                            // console.log($('.sv').val());

                            if ($('.sv').val() == '') {
                                layer.alert('请填写筛选条件',{title:'提示'});
                                return
                            }

                            // //刷新
                            // table.reload('aaa', {
                            //     url:getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetGridData'),
                            //     where:{
                            //         key:$('.sk').val(),
                            //         condition:$('.sc').val(),
                            //         value:$('.sv').val()
                            //     }
                            // });
                            // checkedData = '';

                        }
                        ,btn2: function(index, layero){
                            layer.closeAll();
                            $('#searchs').css('display','none')
                        }
                    });
                });
                // 刷新   
                $('#renovate').click(function(){
                    table.reload('aaa', {
                        url:getAjaxURL('/weftMachineJobSheet/getWeftMachineJobSheetGridData'),
                    });
                    checkedData = '';
                })

                // 關閉/開啟
                $("#close").click(function(){
                    // console.log("关闭-----------------------------------");
                    // window.open("engineeringSchoolClose.html");
                    if (!checkedData) {
                        layer.alert('請選擇關閉/開啟項',{title:'提示'});
                        return
                    }

                    var msg;
                    var changeStatus;
                    if (checkedData.CLOSE_FLAG == '' || checkedData.CLOSE_FLAG == '0') {
                        changeStatus= '1';
                        msg = '真的要啟用該機頭紙嗎？';
                    } else {
                        changeStatus = '0';
                        msg = '真的要關閉該機頭紙嗎？';
                    }

                    //提示
                    layer.confirm(msg, {icon: 3, title: '提示'}, function (index) {
                        //do something
                        $.ajax({
                            type:'POST',                                 
                            url:getAjaxURL('/weftMachineJobSheet/setWeftCloseFlag'),
                            data:{
                                OrderNo:checkedData.PRODUCTION_ORDER_NO,
                                JobSheetNo:checkedData.JOB_SHEET_NO,
                                MachineNo:checkedData.MACHINE_NO,
                                Close_Flag:changeStatus
                            },
                            success:function(data){
                                layer.close(index);
                                if (data.status == 200) {
                                    //成功
                                    $('#renovate').click();

                                } else {
                                    layer.alert(data.message,{title:'提示'});
                                }
                            }
                        })
                    });

                });

                //?OrderNo=800000001&MachineNo=A122PNN&CloseFlag=0&JobSheetNo=W0000186
                //維護用紗
                $("#maintenance").click(function(){
                    // console.log("維護用紗-----------------------------------")
                    if (!checkBeforeOpreate()) {
                        return 
                    }
                    window.open('engineeringSchoolMaintenance.html?OrderNo='+$('#txtOrderNo').val()+'&CloseFlag='+checkedData.CLOSE_FLAG+'&JobSheetNo='+checkedData.JOB_SHEET_NO+'&MACHINE_NO='+checkedData.MACHINE_NO);
                });

                //產生布票
                $("#produce").click(function(){

                    // console.log("產生布票-----------------------------------");
                    if (!checkBeforeOpreate()) {
                        return 
                    }

                    //
                    window.open('engineeringSchoolProduce.html?MACHINE_NO='+checkedData.MACHINE_NO+'&OrderNo='+checkedData.PRODUCTION_ORDER_NO+'&QUANTITY_ALLOTTED='+checkedData.QUANTITY_ALLOTTED+'&CLOSE_FLAG='+checkedData.CLOSE_FLAG+'&JobSheetNo='+checkedData.JOB_SHEET_NO);
                });

                //預覽機頭紙
                $("#preview").click(function(){
                    // console.log(checkedData)
                    if (!checkBeforeOpreate()) {
                        return 
                    }
                    $.ajax({
                        type:"POST",
                        url:getAjaxURL("/warpShiftWorkMaintainReport/downloadPDF"),
                        
                        data:{
                            PRODUCTION_ORDER_NO:orderNo,
                            JOBSHEETNO:checkedData.JOB_SHEET_NO,
                            MachineJobSheetNote:checkedData.MCHN_JOB_SHEET_NOTE,
                            ROTATION_FREQ_PER_POUND:checkedData.ROTATION_FREQ_PER_POUND
                        },
                        success:function(data){
                            console.log(data)
                            console.log(data.message)
                            if(data.status===200){
                                
                            // window.open(getAjaxURL("/"+data.message))
                            window.open(data.message)
                            }else{
                                //alert("导出失败")
                                layer.alert(data.message,{title: "提示"});
                            }
                            
                        }
                    });
                });

                //打印机头纸
                $("#stamp").click(function(){
                    
                    if (!checkBeforeOpreate()) {
                        return 
                    }

                    $.ajax({
                        type:"POST",
                        url:getAjaxURL("/warpShiftWorkMaintainReport/downloadPDF"),
                        
                        data:{
                            PRODUCTION_ORDER_NO:orderNo,
                            JOBSHEETNO:checkedData.JOB_SHEET_NO,
                            MachineJobSheetNote:checkedData.MCHN_JOB_SHEET_NOTE,
                            ROTATION_FREQ_PER_POUND:checkedData.ROTATION_FREQ_PER_POUND
                        },
                        success:function(data){
                            console.log(data)
                            console.log(data.message)
                            if(data.status===200){
                                
                            // window.open(getAjaxURL("/"+data.message));
                            window.open(data.message);
                            }else{
                                //alert("导出失败")
                                layer.alert(data.message,{title: "提示"});
                            }
                            
                        }
                    });
                });
            
                function checkBeforeOpreate(){
                    if (!checkedData) {
                        layer.alert('請選擇項',{title:'提示'});
                        return false
                    }

                    if (checkedData.CLOSE_FLAG === '0') {
                        layer.alert('機頭紙已關閉，不允許操作',{title:'提示'});
                        return false
                    }

                    return true
                }

















            })
        })
    </script>
    <script>
        function timestampToTime(timestamp) {
            var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
            Y = date.getFullYear() + '-';
            M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            D = date.getDate() + ' ';
            return Y+M+D;
        }

        function closeit(a){
            return a.CLOSE_FLAG === '0'? 'checked':'false'
            // return a === '0'? '已關閉':'已開啟'
        }

    </script>       
</html>

<style scoped>
    /*thead .layui-table-cell{
        height:40px;
        line-height:20px;
    }*/
    #searchs button{
        width:18px;
    }
    .layui-form-checkbox{
        height:20px;
        line-height: 20px;
        padding-right: 18px;
    }
    .layui-form-checkbox i{
        font-size:14px;
        width: 20px;
    }
    .layui-form-radio span{
        display: none!important;
    }
    .layui-form-radio{
        margin:0;
        padding:0;
    }
    .layui-form-radio i{
        margin:0;
    }
    #icon{
        display: none;
    }
    .m{
        margin:0 15px;
    }
    *{
        margin: 0;
        padding: 0;
    }
    .top{
        height: 22px;
        line-height: 22px;
        font-size: 16px;
        border-bottom: 1px rgb(26,160,148) solid;
    }
    .layui-input{
        height: 25px;
    }
    .v_d{
        visibility:hidden;
    }
    .layui-input-inline{
        padding: 9px 0;
        width: 170px!important;
    }
    .layui-form-label{
        width: auto;
        padding: 0 15px;
    }
    .clearfix:after{
        content: '';
        display: table;
        clear:both;
        visibility: hidden;
    }
    .f{
        float: left;
    }
    .r{
        color: red;
    }
    .shou{
        cursor: pointer;
    }
    .pad{
        padding: 20px;
    }
    .dis{
        display: none;
    }
</style>