<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>打印布票</title>
	<meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="plugins/servies.js" ></script>
    <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
    <!-- <link rel="stylesheet" type="text/css" href="http://www.jq22.com/jquery/font-awesome.4.6.0.css"> -->
    <script src="build/js/dependencies/rsvp-3.1.0.min.js"></script>
    <script src="build/js/dependencies/sha-256.min.js"></script>
    <!-- // <script type="text/javascript" src="build/js/qz-tray.js"></script> -->
    <script type="text/javascript" src="build/js/additional/jquery-1.11.3.min.js"></script>
    <!-- // <script type="text/javascript" src="build/js/printer.js"></script> -->
</head>
<body>
	<div class="top">
		經編布票產生及打印
	</div>
    <div class="tops">
    	<button class="layui-btn layui-btn-mini" id="keep1" class="keep">產生布票</button>
    	<button class="layui-btn layui-btn-mini" id="keep2" class="keep">打印布票</button>
    	<button class="layui-btn layui-btn-mini" id="keep3" class="keep">選擇最新布票</button>
    </div>
    <div class="tops">
    	<label for="">布票數量:</label><input type="text" id="NoOfLabels">
    	<label for="" style="margin-left:30%">布票號:</label><input type="text" id="barcodeNo">
    </div>
    <div class="tops">
    	<table id="demo" lay-filter="test"></table>
    </div>

</body>
<script type="text/javascript" src="plugins/layui/layui.all.js"></script>
<script type="text/javascript" src="plugins/layui/lay/modules/table.js"></script>
<script src="build/js/di18n.js"></script>
<script src="build/js/lang.js"></script>
<!-- <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.11.3.min.js"></script> -->
<script>
    var layerLoad = null;
    var colArr = [ //表头
		{checkbox: true,},
		// ,{field: '', title: '序號', width:180}
		{field: 'barcodeNo', title: '布票號(批次號)', width:280},
		{field: 'machineNo', title: '生產機號', width:180},
		{field: 'createDate', title: '生產日期', width: 277, templet: '<div>{{ layui.laytpl.toDateString(d.time) }}</div>'},
		{field:"printFlag",width:0,style:"display:none"},
		// {field:"fabric",width:0,style:"display:none"},
    ];
    arrchangeL(colArr);
	$(document).ready(function(){
		  // sessionStorage接受传过来的3个值
		  // var thisURL = sessionStorage["unitGroup1"];  
		  // var getval = sessionStorage["unitGroup2"];  
		  // var showval= sessionStorage["unitGroup3"];
		var printParams = {};
		if (window.location.href.split('?')[1]) {
		    window.location.href.split('?')[1].split('&').forEach(function(item,idx){
		        var k = item.split('=')[0];
		        var v = item.split('=')[1];
		        printParams[k] = v;
		    })
		}
		console.log(printParams)
		  var thisURL = printParams.loca1;  
		  var getval = printParams.loca2;  
		  var showval= printParams.loca3;
		  console.log("sessionStorage传过来的值")
		  console.log(thisURL)
		  console.log(getval)
		  console.log(showval)
		  var jusdge,group = [],unit,num,addNum = {},printPDF='';
		  var selarrow='',materialNo='';
          layui.use(['table','form','layer'], function(){
		  var table = layui.table;
		  var layer = layui.layer;
		  var form = layui.form;
		  //第一个实例
		  table.render({
		    elem: '#demo',
		    height: 415,
		    url:getAjaxURL('/warpMachineJobSheet/getGreigeBarcodeList'), //数据接口
		    response: {
              statusName: 'status', //数据状态的字段名称，默认：code
              statusCode: 200, //成功的状态码，默认：0
              msgName: 'message', //状态信息的字段名称，默认：msg
              countName: 'totals', //数据总数的字段名称，默认：count
              dataName: 'data', //数据列表的字段名称，默认：data
            },
            id:'idTest',
            where: {JobSheetNo:getval},
		    cols: [colArr],
		    //回调函数
		    done: function(res, curr, count){
		    	$('.layui-table-cell')[0].style.zIndex = '-2';
			  	console.log("回调表格函数------------------------------")
			    //如果是异步请求数据方式，res即为你接口返回的信息。
			    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
			    console.log(res);
			    //得到当前页码
			    console.log(curr);
			    //得到数据总量
			    console.log(count);
			},
		  });
          //复选框
		  table.on('checkbox(test)', function(obj){
		  	  console.log("复选框------------------获取值")
			  // console.log(obj.checked); //当前是否选中状态
			  console.log(obj.data); //选中行的相关数据
			  // console.log(obj.type); //如果触发的是全选，则为：all，如果触发的是单选，则为：one
			  jusdge = obj.checked;
			  num = obj.data;
			  if(obj.checked){
			  	  var addData={};
				  addData.id = obj.data.id;
				  addData.fabric = obj.data.fabric;
	              addData.barcodeNo = obj.data.barcodeNo;
	              group.push(addData)
	          }else{
	          	  addNum.id = obj.data.id;
				  addNum.fabric = obj.data.fabric;
	              addNum.barcodeNo = obj.data.barcodeNo;
	              console.log(addNum)
                  group.forEach(function(value,index){
                      if(JSON.stringify(group[index])===JSON.stringify(addNum)){
                          group.splice(index,1)
                      }
                  })
	          }
	          console.log(group)
		  });	
          // 選擇最新布票
          $("#keep3").click(function(){
          	  console.log("选择最新布票---------------------------------gg")
            	$('td[data-field="printFlag"]>div').each(function(index, value) {
			  		if(value.innerText == 0) {
			  			$('tr .layui-form-checkbox').eq(index+1).click();
			  			// $('tr .layui-form-checkbox').eq(index).addClass('layui-form-checked');
			  		}
			  	})
          });
		  //生产布票
          $("#keep1").click(function(){
          	if($("#NoOfLabels").val()==""){
          		$("#NoOfLabels").val('1');
          	}

          		if($("#NoOfLabels").val()%1===0){
		          	  layerLoad = layer.load();
		              $.ajax({
		              	  url:getAjaxURL('/warpMachineJobSheet/createGreigeBarcode'),
		              	  data:{
		              	  	  OrderNo:thisURL,
		              	  	  JobSheetNo:getval,
		              	  	  MachineNo:showval,
		              	  	  NoOfLabels:$("#NoOfLabels").val(),
		              	  	  WCGRP:printParams["WCGRP"],
		              	  	  FABRIC:printParams["FABRIC"],
		              	  	  MAT_DESC:printParams["MAT_DESC"],
		              	  	  userName:"a_test"
		              	  	  // userName:sessionStorage["loginName"]
		              	  },
		              	  success:function(data){
		              	  	layer.close(layerLoad);
		              	  	if (data.status == 200) {
			              	  	console.log(data)
								table.reload('idTest', {
								  url:getAjaxURL('/warpMachineJobSheet/getGreigeBarcodeList')
								});
		              	  	} else {
		              	  		layer.alert(data.message,{title:'提示'});
		              	  	}		
							
		              	  }
		              })
		        }else{
		        	layer.alert('布票數量必須是整數', {
	                    title: "提示"
	                });
		        }
            // }else{
            // 	layer.alert('布票數量不能為空', {
            //         title: "提示"
            //     });
            // }
		  });
		  $("#barcodeNo").keyup(function(event){
		  	if(event.keyCode==13){
			  	if($("#barcodeNo").val()!==""){
	                table.reload('idTest', {
					    url: getAjaxURL('/warpMachineJobSheet/getGreigeBarcodeList'),
					    where: {
					    	barcodeNo:$("#barcodeNo").val(),
					    	JobSheetNo:getval
					    } //设定异步数据接口的额外参数
					});
			  	}else{
			  		layer.alert('請選擇布票號', {
	                    title: "提示"
	                });
			  	}
			}
		  });
		  // 打印布票
		  $("#keep2").on("click",function(){
		  	  console.log(thisURL)
		  	  console.log(getval)
		  	  console.log(showval)
		  	  if(group===undefined||group.length==0){
			  	  layer.alert('請選擇壹行', {
                        title: "提示"
                  });
			  }else{
			  	  printPDF = group;
			  	  for(var i=0;i<printPDF.length;i++){
                      selarrow+=printPDF[i].id+',';
                      materialNo+=printPDF[i].fabric+',';
                      delete printPDF[i].fabric;
			  	  }
			  	  console.log(selarrow)
			  	  console.log(materialNo)
			  	  console.log(printPDF)
			  	  $.ajax({
			  	  	  url:getAjaxURL('/warpMachineJobSheet/printGreigeBarcode'),
			  	  	  data:{
	                      OrderNo:thisURL,
	                      JobSheetNo:getval,
	                      MACHINE_NO:showval,
	                      Selarrow:selarrow,
	                      MATERIAL_NO:materialNo,
	                      GridXml:JSON.stringify(printPDF)
			  	  	  },
			  	  	  success:function(data){
			  	  	  	  	console.log('打印成功---------------')
	                      	console.log(data)
	                      	// con2qz();
	                      	// con2printer();
	                      	if (data.status == 200) {
		                      	file=data.data;
			                    for(var par=0;par<file.length;par++){
			                        // window.open(getAjaxURL(file[par]));
			                        window.open(file[par]);
			                    }
	                      	} else {
		              	  		layer.alert(data.message,{title:'提示'});
		              	  	}	
			  	  	  }
			  	  })
			  }
		  })
		});
	})
</script>
<script>
	/// QZ Config ///
    var cfg = null;
    // 0 qz 公共配置信息
    function getUpdatedConfig() {
        if (cfg == null) {
            cfg = qz.configs.create(null);
        }
        cfg.reconfigure({
                    altPrinting: false,
                    encoding: "",
                    endOfDoc: "",
                    perSpool: "",
                    colorType: "color",
                    copies: 1,
                    density: "",
                    duplex: false,
                    interpolation: "",
                    jobName: "",
                    margins: 0,
                    orientation: "",
                    paperThickness: "",
                    printerTray: "",
                    rasterize: true,
                    rotation: 0,
                    scaleContent: true,
                    size: null,
                    units: "in"
                });
        return cfg;
    }

    // 1 连接QZ print
    function con2qz(){
        qz.websocket.connect().then(function() {
        }).catch(displayError);
    }
    //var config = getUpdatedConfig();
    // 2 连接打印机
    // 
     // var file ='http://172.30.20.145:8080/MES/demo/assets/pdf_sample.pdf';
    // var file ='assets/2018031117162477-05c1c353-f531-41bc-a4a3-0392b317c99c.pdf';
    // var file ='http://172.30.20.126:8080/mes/pdf_upload/2018031117162477-05c1c353-f531-41bc-a4a3-0392b317c99c.pdf';
    // function con2printer(){
    //     // var printer = document.getElementById("printer").value;
    //     qz.websocket.connect().then(function() {
    //     console.log(qz.websocket.isActive());
    //    return qz.printers.getDefault();              // Pass the printer name into the next Promise
    //     }).then(function(printer) {
    //         config = getUpdatedConfig();
    //         config.setPrinter(printer);
    //         console.log(file);
            
    //        var data = [
    //             { type: 'pdf', data: file}
    //         ];
    //         return qz.print(config, data);
        
    //     }).catch(function(e) { console.error(e); });

    // }
</script>
<script>
	//时间戳的处理
	layui.laytpl.toDateString = function(d, format){
		  var date = new Date(d || new Date())
		  ,ymd = [
		    this.digit(date.getFullYear(), 4)
		    ,this.digit(date.getMonth() + 1)
		    ,this.digit(date.getDate())
		  ];
		  // ,hms = [
		  //   this.digit(date.getHours())
		  //   ,this.digit(date.getMinutes())
		  //   ,this.digit(date.getSeconds())
		  // ];

		  format = format || 'yyyy-MM-dd';

		  return format.replace(/yyyy/g, ymd[0])
		  .replace(/MM/g, ymd[1])
		  .replace(/dd/g, ymd[2]);
		  // .replace(/HH/g, hms[0])
		  // .replace(/mm/g, hms[1])
		  // .replace(/ss/g, hms[2]);
	};
	 
	//数字前置补零
	layui.laytpl.digit = function(num, length, end){
		  var str = '';
		  num = String(num);
		  length = length || 2;
		  for(var i = num.length; i < length; i++){
		    str += '0';
		  }
		  return num < Math.pow(10, length) ? str + (num|0) : num;
	};
</script>
<script type="text/html" id="switchTpl">
    <input type="checkbox" name="checkbox" id="pay" lay-skin="primary" {{ d.printFlag == 1 ? 'checked' : '' }}>
</script>

</html>
<style>
	.top{
		color: rgb(32,76,125);
		padding: 5px 15px;
		border-bottom: 2px rgb(30,140,195) solid;
	}
	.tops{
		padding: 5px 15px;
	}
</style>